'use client';

import { useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import imageCompression from 'browser-image-compression';
import { cn } from "../lib/utils";

const DEFAULT_GRADIENT = 'linear-gradient(135deg,#0d47a1,#1976d2)';

/* ---------- BRIGHTNESS ---------- */
function applyBrightnessToGradient(gradient: string, brightness: number) {
  if (!gradient?.includes('linear-gradient')) return gradient;
  const mult = brightness / 100;
  return gradient.replace(/(#\w{6})(\w{2})/g, (match, hex, alpha) => {
    const base = alpha ? parseInt(alpha, 16) : 255;
    const newA = Math.min(255, Math.max(0, base * mult));
    return `${hex}${Math.round(newA).toString(16).padStart(2, '0')}`;
  });
}

/* ---------- BUILD GRADIENT ---------- */
function buildPrizeWheelGradient(start: string, end: string, pos: number, brightness: number) {
  const mid1 = pos;
  const mid2 = Math.min(pos + 15, 100);
  const g = `
    linear-gradient(
      135deg,
      ${start} 0%,
      ${start}cc ${mid1}%,
      ${end}99 ${mid2}%,
      ${end} 100%
    )
  `.replace(/\s+/g, " ");
  return applyBrightnessToGradient(g, brightness);
}

export default function OptionsModalPrizeWheel({
  event,
  hostId,
  onClose,
  refreshPrizeWheels,
}: {
  event: any;
  hostId: string;
  onClose: () => void;
  refreshPrizeWheels: () => Promise<void>;
}) {

  const [saving, setSaving] = useState(false);
  const [uploading, setUploading] = useState(false);

  const [localWheel, setLocalWheel] = useState<any>(() => {
    const start = event.color_start || '#0d47a1';
    const end = event.color_end || '#1976d2';
    const pos = event.gradient_pos ?? 60;
    const bright = event.background_brightness ?? 100;
    const gradient = buildPrizeWheelGradient(start, end, pos, bright);

    return {
      ...event,
      color_start: start,
      color_end: end,
      gradient_pos: pos,
      background_brightness: bright,
      background_type: event.background_type || 'gradient',
      background_value: event.background_value || gradient,
      tile_glow_color: event.tile_glow_color || '#ffffff',
      tile_color_a: event.tile_color_a || '#ffffff',
      tile_color_b: event.tile_color_b || '#ffffff',
      tile_brightness_a: event.tile_brightness_a ?? 100,
      tile_brightness_b: event.tile_brightness_b ?? 100,
      remote_spin_enabled: event.remote_spin_enabled ?? false,
      countdown: event.countdown || 'none',
    };
  });

  /* ---------- IMAGE UPLOAD ---------- */
  async function handleImageUpload(e: any) {
    try {
      const file = e.target.files?.[0];
      if (!file) return;
      if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
        alert('Please upload a JPG, PNG, or WEBP.');
        return;
      }

      const previewUrl = URL.createObjectURL(file);
      setLocalWheel({ ...localWheel, background_type: 'image', background_value: previewUrl });
      setUploading(true);

      const compressed = await imageCompression(file, {
        maxWidthOrHeight: 1900,
        useWebWorker: true
      });

      const ext = file.type.split('/')[1];
      const filePath = `host_${hostId}/prizewheel_${event.id}/background-${Date.now()}.${ext}`;

      await supabase.storage.from('wall-backgrounds')
        .upload(filePath, compressed, { upsert: true });

      const { data: publicUrl } =
        supabase.storage.from('wall-backgrounds').getPublicUrl(filePath);

      const imageUrl = publicUrl.publicUrl;

      await supabase.from('prize_wheels')
        .update({
          background_type: 'image',
          background_value: imageUrl,
          updated_at: new Date().toISOString()
        })
        .eq('id', event.id);

      setLocalWheel({ ...localWheel, background_type: 'image', background_value: imageUrl });
      await refreshPrizeWheels?.();

    } catch (err) {
      console.error(err);
      alert("Upload failed.");
    } finally {
      setUploading(false);
    }
  }

  async function handleSave() {
    try {
      setSaving(true);

      const finalBg =
        localWheel.background_type === "gradient"
          ? applyBrightnessToGradient(localWheel.background_value, localWheel.background_brightness)
          : localWheel.background_value;

      const updates = {
        title: localWheel.title?.trim() || null,
        host_title: localWheel.host_title?.trim() || null,
        visibility: localWheel.visibility,
        passphrase:
          localWheel.visibility === "private" ? localWheel.passphrase || null : null,
        remote_spin_enabled: !!localWheel.remote_spin_enabled,
        countdown:
          localWheel.countdown === "none" ? null : String(localWheel.countdown),
        countdown_active: false,
        background_type: localWheel.background_type,
        background_value: finalBg,
        color_start: localWheel.color_start,
        color_end: localWheel.color_end,
        gradient_pos: localWheel.gradient_pos,
        background_brightness: localWheel.background_brightness,
        tile_glow_color: localWheel.tile_glow_color,
        tile_color_a: localWheel.tile_color_a,
        tile_color_b: localWheel.tile_color_b,
        tile_brightness_a: localWheel.tile_brightness_a,
        tile_brightness_b: localWheel.tile_brightness_b,
        updated_at: new Date().toISOString(),
      };

      await supabase.from('prize_wheels')
        .update(updates)
        .eq('id', localWheel.id);

      await refreshPrizeWheels?.();
      onClose();

    } catch (err) {
      console.error(err);
      alert("Saving failed.");
    } finally {
      setSaving(false);
    }
  }

  /* ---------- UI ---------- */
  return (
    <div
      className={cn(
        'fixed inset-0 bg-black/70 backdrop-blur-md z-[9999] flex items-center justify-center animate-fadeIn'
      )}
      onClick={onClose}
    >
      <div
        onClick={(e) => e.stopPropagation()}
        className={cn(
          'relative w-full max-w-[960px] max-h-[90vh] overflow-hidden rounded-2xl animate-zoomIn',
          'border border-blue-500/30 shadow-[0_0_40px_rgba(0,140,255,0.45)]',
          'bg-gradient-to-br from-[#0b0f1a]/95 to-[#111827]/95 p-6 text-white'
        )}
      >
        <button
          onClick={onClose}
          className={cn('absolute top-3 right-3 text-white/80 hover:text-white text-xl')}
        >
          ✕
        </button>

        <div className={cn('overflow-y-auto max-h-[75vh] pr-1')}>
          <h3 className={cn('text-center text-xl font-bold mb-3')}>
            ⚙ Edit Prize Wheel
          </h3>

          {/* TITLES */}
          <div className={cn('w-full max-w-[520px] mx-auto')}>
            <label className={cn('block', 'mt-3', 'text-sm')}>Private Title</label>
            <input
              type="text"
              value={localWheel.host_title || ''}
              onChange={(e) =>
                setLocalWheel({ ...localWheel, host_title: e.target.value })
              }
              className={cn('w-full', 'p-2', 'rounded-md', 'text-black', 'mt-1')}
            />
          </div>

          <div className={cn('w-full max-w-[520px] mx-auto')}>
            <label className={cn('block', 'mt-3', 'text-sm')}>Public Title</label>
            <input
              type="text"
              value={localWheel.title || ''}
              onChange={(e) =>
                setLocalWheel({ ...localWheel, title: e.target.value })
              }
              className={cn('w-full', 'p-2', 'rounded-md', 'text-black', 'mt-1')}
            />
          </div>

          {/* VISIBILITY */}
          <div className={cn('w-full max-w-[520px] mx-auto')}>
            <label className={cn('block', 'mt-3', 'text-sm')}>Visibility</label>
            <select
              value={localWheel.visibility}
              onChange={(e) =>
                setLocalWheel({ ...localWheel, visibility: e.target.value })
              }
              className={cn('w-full', 'p-2', 'rounded-md', 'text-black', 'mt-1')}
            >
              <option value="public">Public</option>
              <option value="private">Private (passphrase)</option>
            </select>
          </div>

          {localWheel.visibility === 'private' && (
            <div className={cn('w-full max-w-[520px] mx-auto')}>
              <label className={cn('block', 'mt-3', 'text-sm')}>Passphrase</label>
              <input
                type="text"
                value={localWheel.passphrase || ''}
                onChange={(e) =>
                  setLocalWheel({ ...localWheel, passphrase: e.target.value })
                }
                className={cn('w-full', 'p-2', 'rounded-md', 'text-black', 'mt-1')}
              />
            </div>
          )}

          {/* Remote Spin */}
          <div className={cn('w-full max-w-[520px] mx-auto mt-4')}>
            <label className={cn('block', 'text-sm')}>Phone Spin Activation</label>
            <select
              value={localWheel.remote_spin_enabled ? 'yes' : 'no'}
              onChange={(e) =>
                setLocalWheel({
                  ...localWheel,
                  remote_spin_enabled: e.target.value === 'yes',
                })
              }
              className={cn('w-full', 'p-2', 'rounded-md', 'text-black', 'mt-1')}
            >
              <option value="no">Disabled</option>
              <option value="yes">Enabled</option>
            </select>
          </div>

          {/* COUNTDOWN */}
          <div className={cn('w-full max-w-[520px] mx-auto mt-4')}>
            <label className={cn('block', 'text-sm')}>Countdown</label>

            <select
              value={localWheel.countdown || 'none'}
              onChange={(e) =>
                setLocalWheel({ ...localWheel, countdown: e.target.value })
              }
              className={cn('w-full', 'p-2', 'rounded-md', 'text-black', 'mt-1')}
            >
              <option value="none">No Countdown</option>
              <option value="30 Seconds">30 Seconds</option>
              <option value="1 Minute">1 Minute</option>
              <option value="2 Minutes">2 Minutes</option>
              <option value="3 Minutes">3 Minutes</option>
              <option value="4 Minutes">4 Minutes</option>
              <option value="5 Minutes">5 Minutes</option>
            </select>
          </div>

          {/* BACKGROUND PREVIEW */}
          <div className={cn('w-full', 'max-w-[520px]', 'mx-auto', 'mt-6', 'text-center')}>
            <div
              className={cn('mx-auto', 'w-[140px]', 'rounded-md', 'border', 'border-white/10', 'shadow-inner', 'overflow-hidden', 'aspect-[16/9]')}
              style={{
                background:
                  localWheel.background_type === 'image'
                    ? `url(${localWheel.background_value}) center/cover no-repeat`
                    : localWheel.background_value,
              }}
            />
          </div>

          {/* GRADIENT CONTROLS */}
          <div className={cn('w-full', 'max-w-[520px]', 'mx-auto', 'mt-6')}>
            <div className={cn('flex', 'justify-center', 'gap-6')}>
              {['Left Color', 'Right Color'].map((label, i) => (
                <div key={label}>
                  <label className={cn('block', 'text-xs', 'mb-1')}>{label}</label>
                  <input
                    type="color"
                    value={i === 0 ? localWheel.color_start : localWheel.color_end}
                    onChange={(e) => {
                      const newStart = i === 0 ? e.target.value : localWheel.color_start;
                      const newEnd = i === 1 ? e.target.value : localWheel.color_end;
                      const g = buildPrizeWheelGradient(
                        newStart,
                        newEnd,
                        localWheel.gradient_pos,
                        localWheel.background_brightness
                      );
                      setLocalWheel({
                        ...localWheel,
                        color_start: newStart,
                        color_end: newEnd,
                        background_type: 'gradient',
                        background_value: g,
                      });
                    }}
                  />
                </div>
              ))}
            </div>

            {/* Gradient + Brightness Sliders */}
            {[
              { label: 'Gradient Position', key: 'gradient_pos' },
              { label: 'Background Brightness', key: 'background_brightness' },
            ].map(({ label, key }) => (
              <div key={key} className={cn('mt-5', 'flex', 'flex-col', 'items-center')}>
                <label className={cn('text-xs', 'mb-1')}>{label}</label>
                <div className={cn('w-[160px]', 'p-2', 'rounded-md', 'bg-[#0f172a]/40', 'shadow-inner')}>
                  <input
                    type="range"
                    min="20"
                    max="150"
                    value={localWheel[key]}
                    onChange={(e) =>
                      setLocalWheel({
                        ...localWheel,
                        [key]: Number(e.target.value),
                        background_value: buildPrizeWheelGradient(
                          localWheel.color_start,
                          localWheel.color_end,
                          key === 'gradient_pos'
                            ? Number(e.target.value)
                            : localWheel.gradient_pos,
                          key === 'background_brightness'
                            ? Number(e.target.value)
                            : localWheel.background_brightness
                        ),
                      })
                    }
                    className={cn('w-full', 'accent-blue-400')}
                  />
                </div>
                <p className={cn('text-xs', 'mt-1')}>{localWheel[key]}%</p>
              </div>
            ))}
          </div>

          {/* TILE COLORS */}
          <p className={cn('text-red-400', 'text-xs', 'text-center', 'mt-8', 'mb-2')}>
            These must be selected before the wheel window is launched.
          </p>

          <div className={cn('w-full', 'max-w-[520px]', 'mx-auto', 'mt-4', 'flex', 'justify-center')}>
            <div className={cn(
              'flex',
              'flex-row',
              'gap-12',
              'p-4',
              'rounded-xl',
              'border',
              'border-white/10',
              'bg-black/20',
              'shadow-inner'
            )}>

              <div className={cn('flex', 'flex-col', 'items-center')}>
                <label className={cn('text-sm', 'font-semibold', 'mb-2')}>Glow</label>
                <input
                  type="color"
                  value={localWheel.tile_glow_color}
                  onChange={(e) =>
                    setLocalWheel({
                      ...localWheel,
                      tile_glow_color: e.target.value,
                    })
                  }
                  className={cn('w-10', 'h-10', 'rounded-md', 'border', 'border-white/20')}
                />
                <div
                  className={cn('h-10', 'w-16', 'mt-2', 'rounded-md', 'border', 'border-white/20')}
                  style={{
                    background: '#111',
                    boxShadow: `0 0 20px ${localWheel.tile_glow_color}`,
                  }}
                />
              </div>

              <div className={cn('flex', 'flex-col', 'items-center')}>
                <label className={cn('text-sm', 'font-semibold', 'mb-2')}>Tile A</label>
                <input
                  type="color"
                  value={localWheel.tile_color_a}
                  onChange={(e) =>
                    setLocalWheel({
                      ...localWheel,
                      tile_color_a: e.target.value,
                    })
                  }
                  className={cn('w-10', 'h-10', 'rounded-md', 'border', 'border-white/20')}
                />
                <div
                  className={cn('h-10', 'w-16', 'mt-2', 'rounded-md', 'border', 'border-white/20')}
                  style={{
                    background: localWheel.tile_color_a,
                    opacity: localWheel.tile_brightness_a / 100,
                  }}
                />
              </div>

              <div className={cn('flex', 'flex-col', 'items-center')}>
                <label className={cn('text-sm', 'font-semibold', 'mb-2')}>Tile B</label>
                <input
                  type="color"
                  value={localWheel.tile_color_b}
                  onChange={(e) =>
                    setLocalWheel({
                      ...localWheel,
                      tile_color_b: e.target.value,
                    })
                  }
                  className={cn('w-10', 'h-10', 'rounded-md', 'border', 'border-white/20')}
                />
                <div
                  className={cn('h-10', 'w-16', 'mt-2', 'rounded-md', 'border', 'border-white/20')}
                  style={{
                    background: localWheel.tile_color_b,
                    opacity: localWheel.tile_brightness_b / 100,
                  }}
                />
              </div>

            </div>
          </div>

          {/* ✅ TILE BRIGHTNESS */}
          <div className={cn('w-full', 'max-w-[520px]', 'mx-auto', 'mt-6')}>
            {/* A */}
            <div className={cn('mb-4', 'flex', 'flex-col', 'items-center')}>
              <label className={cn('block', 'text-xs', 'mb-1')}>Tile A Brightness</label>
              <div className={cn('w-[160px]', 'p-2', 'rounded-md', 'bg-[#0f172a]/40', 'shadow-inner')}>
                <input
                  type="range"
                  min="20"
                  max="150"
                  value={localWheel.tile_brightness_a}
                  onChange={(e) =>
                    setLocalWheel({
                      ...localWheel,
                      tile_brightness_a: Number(e.target.value),
                    })
                  }
                  className={cn('w-full', 'accent-blue-400')}
                />
              </div>
            </div>

            {/* B */}
            <div className={cn('mb-4', 'flex', 'flex-col', 'items-center')}>
              <label className={cn('block', 'text-xs', 'mb-1')}>Tile B Brightness</label>
              <div className={cn('w-[160px]', 'p-2', 'rounded-md', 'bg-[#0f172a]/40', 'shadow-inner')}>
                <input
                  type="range"
                  min="20"
                  max="150"
                  value={localWheel.tile_brightness_b}
                  onChange={(e) =>
                    setLocalWheel({
                      ...localWheel,
                      tile_brightness_b: Number(e.target.value),
                    })
                  }
                  className={cn('w-full', 'accent-blue-400')}
                />
              </div>
            </div>

          </div>

          {/* BACKGROUND UPLOAD */}
          <div className={cn('mt-6', 'text-center', 'w-full', 'max-w-[520px]', 'mx-auto')}>
            <p className={cn('text-sm', 'font-semibold', 'mb-2')}>Upload Background</p>

            <input
              type="file"
              accept="image/jpeg,image/png,image/webp"
              onChange={handleImageUpload}
              className="w-full"
            />

            {uploading && (
              <p className={cn('text-yellow-400', 'text-xs', 'mt-2', 'animate-pulse')}>
                Uploading…
              </p>
            )}
          </div>

          {/* SAVE + CLOSE */}
          <div className={cn('text-center', 'mt-6', 'flex', 'justify-center', 'gap-4')}>
            <button
              disabled={saving}
              onClick={handleSave}
              className={cn(
                saving ? 'bg-gray-500' : 'bg-green-600 hover:bg-green-700',
                'px-4 py-2 rounded font-semibold'
              )}
            >
              {saving ? 'Saving…' : 'Save'}
            </button>

            <button
              onClick={onClose}
              className={cn('bg-red-600', 'hover:bg-red-700', 'px-4', 'py-2', 'rounded', 'font-semibold')}
            >
              Close
            </button>
          </div>

        </div>
      </div>
    </div>
  );
}
